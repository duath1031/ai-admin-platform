generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                      String                   @id @default(cuid())
  name                    String?
  email                   String?                  @unique
  emailVerified           DateTime?
  image                   String?
  phone                   String?
  credits                 Int                      @default(0)
  plan                    String                   @default("none")
  role                    Role                     @default(USER)
  marketingConsent        Boolean                  @default(false)
  lastLoginAt             DateTime?
  overageEnabled          Boolean                  @default(false)
  overageMonthlyLimit     Int                      @default(50000) // 월 최대 초과과금 (원)
  overageSpentThisMonth   Int                      @default(0)     // 이번 달 초과과금 누적 (원)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  accounts                Account[]
  apiLogs                 ApiLog[]
  chats                   Chat[]
  civilServiceSubmissions CivilServiceSubmission[]
  companyProfile          CompanyProfile?
  creditTransactions      CreditTransaction[]
  documents               Document[]
  documentLogs            DocumentLog[]
  payments                Payment[]
  powersOfAttorney        PowerOfAttorney[]
  rpaTasks                RpaTask[]
  sessions                Session[]
  subscriptions           Subscription[]
  doc24Account            Doc24Account?
  doc24Submissions        Doc24Submission[]
  billingKeys             BillingKey[]
  subsidyMatches          SubsidyMatch[]
  deadlineAlerts          DeadlineAlert[]
  employees               Employee[]
  clientCompanies         ClientCompany[]
}

// 거래처 기업 프로필 (행정사가 관리하는 거래처 사업장)
model ClientCompany {
  id            String   @id @default(cuid())
  userId        String
  companyName   String   // 거래처 상호
  ownerName     String?  // 대표자명
  bizRegNo      String?  // 사업자등록번호
  address       String?  // 주소
  phone         String?  // 전화번호
  npBizNo       String?  // 국민연금 사업장관리번호
  hiBizNo       String?  // 건강보험 사업장관리번호
  eiBizNo       String?  // 고용·산재보험 사업장관리번호
  memo          String?

  // Section 2: 식별 상세
  ceoGender         String?   // 대표자 성별 (male/female)
  corpRegNo         String?   // 법인등록번호
  bizType           String?   // 업태/종목
  foundedDate       DateTime? // 설립일/개업일

  // Section 3: 업종 상세
  businessSector    String?   // 업종 대분류 (제조업/서비스업/건설업 등)
  industryCode      String?   // 한국표준산업분류 코드
  industryName      String?   // 산업분류명
  businessSubType   String?   // 세부업종

  // Section 4: 재무 정보 (최근 3개년)
  revenueYear1          BigInt?  // 매출액 1차년도
  revenueYear2          BigInt?  // 매출액 2차년도
  revenueYear3          BigInt?  // 매출액 3차년도
  revenueLabel1         String?  // 예: "2025년"
  revenueLabel2         String?  // 예: "2024년"
  revenueLabel3         String?  // 예: "2023년"
  operatingProfitYear1  BigInt?  // 영업이익 1차년도
  operatingProfitYear2  BigInt?  // 영업이익 2차년도
  operatingProfitYear3  BigInt?  // 영업이익 3차년도
  netIncomeYear1        BigInt?  // 당기순이익 1차년도
  netIncomeYear2        BigInt?  // 당기순이익 2차년도
  netIncomeYear3        BigInt?  // 당기순이익 3차년도
  totalAssets           BigInt?  // 총자산
  totalLiabilities      BigInt?  // 총부채
  capital               BigInt?  // 자본금
  rndExpenditure        BigInt?  // 연구개발비
  exportAmount          BigInt?  // 수출액

  // Section 5: 고용 정보
  employeeCount         Int      @default(0)  // 상시근로자 수
  permanentEmployees    Int?     // 정규직 수
  contractEmployees     Int?     // 계약직 수
  researcherCount       Int?     // 연구원 수
  foreignEmployees      Int?     // 외국인 근로자 수

  // Section 6: 연구소/전담부서
  hasResearchInstitute  Boolean  @default(false)
  hasRndDepartment      Boolean  @default(false)
  researchInstituteDate DateTime?

  // Section 7: 제조업 정보
  isManufacturer        Boolean  @default(false)
  manufacturingItems    String?  // 제조물품 (콤마 구분)
  factoryAddress        String?  // 공장 소재지
  factoryArea           String?  // 공장 면적 (㎡)
  manufacturingCerts    String?  // 제조 관련 인증 (HACCP, GMP, KS 등)
  mainRawMaterials      String?  // 주요 원자재

  // Section 8: 조달/입찰 정보
  isG2bRegistered       Boolean  @default(false)
  g2bRegistrationNumber String?  // 나라장터 업체등록번호
  mainProducts          String?  // 주요 생산품목 (콤마 구분)
  hasDirectProductionCert Boolean @default(false)
  hasMasContract        Boolean  @default(false)

  // Section 9: 수출/외국인
  isExporter            Boolean  @default(false)
  exportCountries       String?  // 수출 대상국
  hasForeignWorkers     Boolean  @default(false)
  foreignWorkerVisaTypes String? // 비자 유형

  // Section 10: 기업인증
  isVentureCertified    Boolean  @default(false)  // 벤처기업 인증
  ventureExpiry         DateTime?                   // 벤처기업 만료일
  isInnobiz             Boolean  @default(false)  // 이노비즈 인증
  isMainbiz             Boolean  @default(false)  // 메인비즈 인증
  isISO9001             Boolean  @default(false)  // ISO 9001
  isISO14001            Boolean  @default(false)  // ISO 14001
  isISO45001            Boolean  @default(false)  // ISO 45001
  isWomenBiz            Boolean  @default(false)  // 여성기업
  isSocialEnterprise    Boolean  @default(false)  // 사회적기업
  isRootCompany         Boolean  @default(false)  // 뿌리기업
  otherCertifications   String?                     // 기타 인증 (콤마 구분)

  // Section 11: 특허/지식재산권
  patentCount           Int      @default(0)       // 등록 특허
  utilityModelCount     Int      @default(0)       // 실용신안
  designPatentCount     Int      @default(0)       // 디자인등록
  trademarkCount        Int      @default(0)       // 상표등록
  swCopyrightCount      Int      @default(0)       // SW 저작권
  patentDetails         String?                     // 주요 특허/IP 상세 (텍스트)

  // 메타
  profileCompleteness   Int      @default(0) // 0~100

  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employees     Employee[]
  vehicles      Vehicle[]

  @@index([userId])
}

// 기업 마스터 프로필 (AI 비서의 기억 저장소)
model CompanyProfile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Section 1: 필수 식별 정보 (서류 자동완성용)
  companyName   String?   // 상호
  ownerName     String?   // 대표자명
  ceoGender     String?   // 대표자 성별 (male/female)
  bizRegNo      String?   // 사업자등록번호 (10자리)
  corpRegNo     String?   // 법인등록번호 (선택)
  address       String?   // 주소
  bizType       String?   // 업태/종목
  foundedDate   DateTime? // 설립일

  // Section 2: 업종 상세
  businessSector    String?   // 업종 대분류 (제조업/서비스업/건설업 등)
  industryCode      String?   // 한국표준산업분류 코드
  industryName      String?   // 산업분류명
  businessSubType   String?   // 세부업종
  establishmentDate DateTime? // 사업 개시일

  // Section 3: 재무 정보 (최근 3개년)
  revenueYear1          BigInt?  // 매출액 1차년도
  revenueYear2          BigInt?  // 매출액 2차년도
  revenueYear3          BigInt?  // 매출액 3차년도
  revenueLabel1         String?  // 예: "2024년"
  revenueLabel2         String?  // 예: "2023년"
  revenueLabel3         String?  // 예: "2022년"
  operatingProfitYear1  BigInt?  // 영업이익 1차년도
  operatingProfitYear2  BigInt?  // 영업이익 2차년도
  operatingProfitYear3  BigInt?  // 영업이익 3차년도
  netIncomeYear1        BigInt?  // 당기순이익 1차년도
  netIncomeYear2        BigInt?  // 당기순이익 2차년도
  netIncomeYear3        BigInt?  // 당기순이익 3차년도
  totalAssets           BigInt?  // 총자산
  totalLiabilities      BigInt?  // 총부채
  rndExpenditure        BigInt?  // 연구개발비
  exportAmount          BigInt?  // 수출액

  // Section 4: 고용 정보
  employeeCount         Int      @default(0) // 상시근로자 수
  permanentEmployees    Int?     // 정규직 수
  researcherCount       Int?     // 연구원 수
  foreignEmployees      Int?     // 외국인 근로자 수
  capital               BigInt   @default(0) // 자본금

  // Section 7: 연구소/전담부서
  hasResearchInstitute  Boolean  @default(false) // 기업부설연구소
  hasRndDepartment      Boolean  @default(false) // 연구개발전담부서
  researchInstituteDate DateTime? // 연구소 인정일

  // Section 7-1: 제조업 정보 (제조업체인 경우)
  isManufacturer        Boolean  @default(false) // 제조업체 여부
  manufacturingItems    String?  // 제조물품 (JSON 배열)
  factoryAddress        String?  // 공장 소재지
  factoryArea           String?  // 공장 면적 (㎡)
  manufacturingCerts    String?  // 제조 관련 인증 (HACCP, GMP, KS 등 JSON)
  hasFactoryRegistration Boolean @default(false) // 공장등록증 보유
  mainRawMaterials      String?  // 주요 원자재 (JSON)

  // Section 8: 조달 정보
  isG2bRegistered       Boolean  @default(false) // 나라장터 등록 여부
  g2bRegistrationNumber String?  // 나라장터 업체등록번호
  mainProducts          String?  // 주요 생산품목 (JSON)
  productClassificationCodes String? // 물품분류번호 (JSON)
  hasDirectProductionCert Boolean @default(false) // 직접생산확인증명
  hasMasContract        Boolean  @default(false) // 다수공급자계약(MAS) 여부
  masItems              String?  // MAS 품목 (JSON)

  // Section 9: 수출 정보
  isExporter            Boolean  @default(false) // 수출 기업 여부
  exportCountries       String?  // 수출 대상국 (JSON)
  importItems           String?  // 수입 품목 (JSON)

  // Section 10: 외국인 관련
  hasForeignWorkers     Boolean  @default(false) // 외국인 고용 여부
  foreignWorkerVisaTypes String? // 비자 유형 (JSON)

  // 메타
  profileCompleteness   Int      @default(0) // 프로필 완성도 (0-100)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  licenses       ConstructionLicense[]
  certifications CompanyCertification[]
  patents        CompanyPatent[]
  performances   PerformanceRecord[]
  bidHistory     BidHistoryRecord[]

  @@index([userId])
}

// 건설 면허
model ConstructionLicense {
  id              String         @id @default(cuid())
  companyProfileId String
  companyProfile  CompanyProfile @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  licenseType     String         // 면허 종류 (토목, 건축, 산업환경설비 등)
  licenseNumber   String?        // 면허 번호
  grade           String?        // 등급
  capacity        BigInt?        // 시공능력평가액
  issueDate       DateTime?      // 취득일
  expiryDate      DateTime?      // 만료일
  isActive        Boolean        @default(true)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([companyProfileId])
}

// 기업 인증 (벤처/이노비즈/메인비즈 등)
model CompanyCertification {
  id              String         @id @default(cuid())
  companyProfileId String
  companyProfile  CompanyProfile @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  certType        String         // 인증 유형 (venture, innobiz, mainbiz, iso9001 등)
  certName        String         // 인증명
  certNumber      String?        // 인증번호
  issuer          String?        // 발급기관
  issueDate       DateTime?      // 발급일
  expiryDate      DateTime?      // 만료일
  isActive        Boolean        @default(true)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([companyProfileId])
}

// 지식재산권 (특허/실용신안/상표 등)
model CompanyPatent {
  id              String         @id @default(cuid())
  companyProfileId String
  companyProfile  CompanyProfile @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  patentType      String         // 종류 (patent, utility_model, trademark, design)
  title           String         // 명칭
  registrationNo  String?        // 등록번호
  applicationNo   String?        // 출원번호
  status          String         @default("registered") // registered, pending, expired
  registrationDate DateTime?     // 등록일
  expiryDate      DateTime?      // 만료일

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([companyProfileId])
}

// 수행실적 (전업종)
model PerformanceRecord {
  id              String         @id @default(cuid())
  companyProfileId String
  companyProfile  CompanyProfile @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  projectName     String         // 사업명
  clientName      String?        // 발주처
  contractAmount  BigInt?        // 계약금액
  startDate       DateTime?      // 착수일
  endDate         DateTime?      // 완료일
  projectType     String?        // 유형 (service, goods, construction)
  description     String?        // 비고

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([companyProfileId])
}

// 과거 입찰 이력
model BidHistoryRecord {
  id              String         @id @default(cuid())
  companyProfileId String
  companyProfile  CompanyProfile @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  bidNo           String?        // 공고번호
  bidName         String         // 공고명
  agency          String?        // 발주기관
  bidAmount       BigInt?        // 투찰금액
  estimatedPrice  BigInt?        // 예정가격
  bidDate         DateTime?      // 투찰일
  result          String?        // 결과 (won, lost, cancelled)
  bidRate         Float?         // 투찰률 (%)
  notes           String?        // 비고

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([companyProfileId])
}

model Document {
  id        String        @id @default(cuid())
  title     String
  type      String
  content   String
  inputData String?
  fileUrl   String?
  status    String        @default("draft")
  version   Int           @default(1)
  userId    String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs      DocumentLog[]
}

model DocumentLog {
  id             String    @id @default(cuid())
  documentId     String?
  documentType   String
  templateUsed   String?
  aiModel        String?
  inputContext   String?
  aiPrompt       String?
  aiResponse     String?
  generationTime Int?
  tokenCount     Int?
  fileSize       Int?
  status         String    @default("success")
  errorMessage   String?
  userId         String
  createdAt      DateTime  @default(now())
  document       Document? @relation(fields: [documentId], references: [id])
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RpaTask {
  id             String    @id @default(cuid())
  taskType       String
  targetSite     String
  targetUrl      String?
  formData       String
  fieldMappings  String?
  status         String    @default("pending")
  progress       Int       @default(0)
  startedAt      DateTime?
  completedAt    DateTime?
  executionLog   String?
  screenshotUrl  String?
  errorMessage   String?
  retryCount     Int       @default(0)
  maxRetries     Int       @default(3)
  userId         String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  authPhase      String?
  sessionCookies String?
  workerId       String?
  workerTaskId   String?
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([taskType])
  @@index([workerId])
}

model ApiLog {
  id            String   @id @default(cuid())
  apiName       String
  endpoint      String
  method        String   @default("GET")
  requestParams String?
  responseCode  Int?
  responseData  String?
  dataCount     Int?
  latency       Int?
  status        String   @default("success")
  errorMessage  String?
  userId        String?
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id])
}

model Chat {
  id        String    @id @default(cuid())
  title     String?
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
}

model Message {
  id        String   @id @default(cuid())
  role      String
  content   String
  metadata  String?
  chatId    String
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
}

model ReviewRequest {
  id             String   @id @default(cuid())
  fileName       String
  fileUrl        String
  fileType       String
  analysisResult String?
  suggestions    String?
  status         String   @default("pending")
  userId         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model PowerOfAttorney {
  id               String                   @id @default(cuid())
  delegatorName    String
  delegatorBirth   String
  delegatorPhone   String
  delegatorIdHash  String
  delegatorAddress String?
  serviceType      String
  serviceName      String
  serviceCode      String?
  delegationScope  String?
  signatureData    String
  signatureHash    String
  signedAt         DateTime
  validFrom        DateTime
  validTo          DateTime
  status           String                   @default("active")
  revokedAt        DateTime?
  revokedReason    String?
  userId           String
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  submissions      CivilServiceSubmission[]
  user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([validTo])
}

model CivilServiceSubmission {
  id                String                  @id @default(cuid())
  serviceName       String
  serviceCode       String?
  targetSite        String
  targetUrl         String?
  applicationData   String
  applicantName     String
  applicantBirth    String?
  applicantPhone    String?
  powerOfAttorneyId String?
  status            String                  @default("draft")
  progress          Int                     @default(0)
  applicationNumber String?
  receiptUrl        String?
  resultData        String?
  completedAt       DateTime?
  errorMessage      String?
  retryCount        Int                     @default(0)
  maxRetries        Int                     @default(3)
  userId            String
  creditsUsed       Int                     @default(0)
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  powerOfAttorney   PowerOfAttorney?        @relation(fields: [powerOfAttorneyId], references: [id])
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  trackingLogs      SubmissionTrackingLog[]

  @@index([userId])
  @@index([status])
  @@index([applicationNumber])
}

model SubmissionTrackingLog {
  id            String                 @id @default(cuid())
  submissionId  String
  step          String
  stepOrder     Int
  status        String
  message       String?
  screenshotUrl String?
  htmlSnapshot  String?
  startedAt     DateTime?
  completedAt   DateTime?
  duration      Int?
  createdAt     DateTime               @default(now())
  submission    CivilServiceSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([step])
}

model SubscriptionPlan {
  id                    String         @id @default(cuid())
  name                  String         @unique
  planCode              String         @unique  // starter, standard, pro, pro_plus
  displayName           String
  price                 Int
  credits               Int
  tokenQuota            Int            @default(0)  // 월간 토큰 한도
  trialDays             Int            @default(0)  // 무료 체험 일수
  maxFeatures           String?        // 플랜별 기능 제한 (JSON)
  features              String
  isActive              Boolean        @default(true)
  sortOrder             Int            @default(0)
  overageEnabled        Boolean        @default(true)
  overagePricePerCredit Int            @default(100)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  subscriptions         Subscription[]
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String
  planId            String
  billingKeyId      String?
  status            String             @default("active") // trial, active, past_due, grace, cancelled, expired
  startDate         DateTime           @default(now())
  endDate           DateTime?
  cancelledAt       DateTime?
  billingCycle      String             @default("monthly")
  nextBillingDate   DateTime?
  trialEndsAt       DateTime?
  gracePeriodEndsAt DateTime?
  retryCount        Int                @default(0)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  payments          Payment[]
  scheduledPayments ScheduledPayment[]
  plan              SubscriptionPlan   @relation(fields: [planId], references: [id])
  billingKey        BillingKey?        @relation(fields: [billingKeyId], references: [id])
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Payment {
  id             String        @id @default(cuid())
  userId         String
  subscriptionId String?
  orderId        String        @unique
  paymentKey     String?
  amount         Int
  itemType       String
  itemName       String
  itemQuantity   Int           @default(1)
  status         String        @default("pending")
  method         String?
  requestedAt    DateTime      @default(now())
  approvedAt     DateTime?
  cancelledAt    DateTime?
  failReason     String?
  metadata       String?
  impUid         String?
  receiptUrl     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderId])
  @@index([status])
}

model CreditTransaction {
  id            String   @id @default(cuid())
  userId        String
  amount        Int
  balance       Int
  type          String
  description   String?
  referenceType String?
  referenceId   String?
  isOverage     Boolean  @default(false)
  overageAmount Int?
  overageCharge Int?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([isOverage])
}

model OverageCharge {
  id              String   @id @default(cuid())
  userId          String
  billingMonth    String
  includedCredits Int
  usedCredits     Int
  overageCredits  Int
  pricePerCredit  Int
  totalCharge     Int
  status          String   @default("pending")
  paymentId       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, billingMonth])
  @@index([userId])
  @@index([status])
}

model SubmissionRequest {
  id             String    @id @default(cuid())
  type           String
  name           String
  phone          String
  email          String
  documentType   String
  description    String?
  attachmentUrls String?
  status         String    @default("pending")
  adminNote      String?
  emailSent      Boolean   @default(false)
  smsSent        Boolean   @default(false)
  kakaoSent      Boolean   @default(false)
  userId         String?
  assignedTo     String?
  processedAt    DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model Notification {
  id            String    @id @default(cuid())
  userId        String
  type          String
  title         String
  message       String
  channel       String
  status        String    @default("pending")
  sentAt        DateTime?
  isRead        Boolean   @default(false)
  readAt        DateTime?
  referenceType String?
  referenceId   String?
  errorMessage  String?
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@index([isRead])
}

model SystemPrompt {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  content     String
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  version     Int      @default(1)
  createdBy   String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([isDefault])
}

model SiteSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  category    String
  value       String
  valueType   String   @default("string")
  displayName String
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

model FormTemplate {
  id                  String   @id @default(cuid())
  code                String   @unique
  name                String
  category            String
  description         String?

  // 파일 저장
  originalFileUrl     String?
  originalFileType    String?
  docxStoragePath     String?
  docxStorageProvider String   @default("supabase")

  // 필드 정의 (JSON string)
  fields              String

  // 메타데이터
  gov24ServiceKey     String?
  requiredDocs        String?
  tips                String?
  outputFileName      String?

  // 상태
  status              String   @default("active")
  version             Int      @default(1)
  uploadedBy          String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([category])
  @@index([status])
}

model KnowledgeDocument {
  id           String           @id @default(cuid())
  fileName     String
  fileType     String
  fileUrl      String?
  fileSize     Int?
  title        String?
  category     String?
  tags         String?
  description  String?
  status       String           @default("pending")
  errorMessage String?
  totalChunks  Int              @default(0)
  totalTokens  Int?
  uploadedBy   String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  chunks       KnowledgeChunk[]

  // 영구 저장소 (The Vault) - Supabase Storage
  storagePath      String?    // Supabase Storage 경로 (knowledge/{uuid}/{filename})
  storageProvider  String     @default("supabase") // 'supabase' | 's3'

  // Gemini File API 필드 (임시 캐시 - 48시간 만료)
  geminiFileUri    String?    // Google File API에서 반환된 URI
  geminiMimeType   String?    // 파일 MIME 타입
  geminiFileName   String?    // Google 내부 파일명 (삭제용)
  geminiExpiresAt  DateTime?  // 파일 만료 시간 (48시간)
  processingMode   String     @default("gemini_file") // 'legacy_rag' | 'gemini_file'

  @@index([status])
  @@index([category])
  @@index([fileType])
  @@index([processingMode])
}

model KnowledgeChunk {
  id           String                 @id @default(cuid())
  documentId   String
  content      String
  chunkIndex   Int
  pageNumber   Int?
  sectionTitle String?
  tokenCount   Int?
  createdAt    DateTime               @default(now())
  embedding    Unsupported("vector")?
  document     KnowledgeDocument      @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([chunkIndex])
  @@index([embedding], map: "knowledge_chunk_embedding_idx")
}

// ─────────────────────────────────────────
// 조달 데이터 아카이빙 (Phase 25)
// ─────────────────────────────────────────

enum ProcurementType {
  SERVICE      // 용역
  GOODS        // 물품
  CONSTRUCTION // 공사
}

enum ProcurementStatus {
  OPEN         // 진행중
  CLOSED       // 마감
  AWARDED      // 낙찰완료
}

model Procurement {
  id              String            @id @default(cuid())

  // 공고 식별정보
  bidNo           String            @unique  // 공고번호
  bidNtceNm       String                     // 공고명

  // 발주처 정보
  agency          String                     // 발주기관
  demandAgency    String?                    // 수요기관
  region          String?                    // 지역

  // 금액 정보 (원 단위)
  foundationAmt   BigInt?                    // 기초금액
  preAmt          BigInt?                    // 예정가격 (사정률 적용 후)
  bidWinAmt       BigInt?                    // 낙찰금액

  // 낙찰 정보
  winner          String?                    // 낙찰업체명
  winnerBizNo     String?                    // 낙찰업체 사업자번호
  bidRate         Float?                     // 낙찰률 (%)
  participantCnt  Int?                       // 참가업체수

  // 분류 및 메타데이터
  type            ProcurementType            // 용역/물품/공사
  status          ProcurementStatus @default(OPEN)
  bidMethod       String?                    // 입찰방법 (일반경쟁/제한경쟁 등)
  awardMethod     String?                    // 낙찰방법 (최저가/적격심사 등)

  // 일자
  announceDt      DateTime?                  // 공고일
  openingDt       DateTime?                  // 개찰일
  closeDt         DateTime?                  // 마감일

  // URL
  detailUrl       String?                    // 상세 페이지 URL

  // 수집 메타
  collectedAt     DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  source          String            @default("g2b") // 데이터 소스

  // Relations
  reservePriceDetail ReservePriceDetail?

  @@index([agency])
  @@index([type])
  @@index([status])
  @@index([region])
  @@index([announceDt])
  @@index([openingDt])
  @@index([winner])
}

// ─────────────────────────────────────────
// 복수예비가격 상세 (입찰 시뮬레이터용)
// ─────────────────────────────────────────

model ReservePriceDetail {
  id              String       @id @default(cuid())
  bidNo           String       @unique  // 공고번호
  bssamt          BigInt?      // 기초금액
  plnprc          BigInt?      // 예정가격
  assessmentRate  Float?       // 사정률 (예정가격/기초금액*100)

  // 15개 예비가격 + 추첨여부
  rsrvPrc1        BigInt?
  rsrvPrc2        BigInt?
  rsrvPrc3        BigInt?
  rsrvPrc4        BigInt?
  rsrvPrc5        BigInt?
  rsrvPrc6        BigInt?
  rsrvPrc7        BigInt?
  rsrvPrc8        BigInt?
  rsrvPrc9        BigInt?
  rsrvPrc10       BigInt?
  rsrvPrc11       BigInt?
  rsrvPrc12       BigInt?
  rsrvPrc13       BigInt?
  rsrvPrc14       BigInt?
  rsrvPrc15       BigInt?

  drwtYn1         Boolean      @default(false)
  drwtYn2         Boolean      @default(false)
  drwtYn3         Boolean      @default(false)
  drwtYn4         Boolean      @default(false)
  drwtYn5         Boolean      @default(false)
  drwtYn6         Boolean      @default(false)
  drwtYn7         Boolean      @default(false)
  drwtYn8         Boolean      @default(false)
  drwtYn9         Boolean      @default(false)
  drwtYn10        Boolean      @default(false)
  drwtYn11        Boolean      @default(false)
  drwtYn12        Boolean      @default(false)
  drwtYn13        Boolean      @default(false)
  drwtYn14        Boolean      @default(false)
  drwtYn15        Boolean      @default(false)

  openingDt       DateTime?    // 개찰일시

  // Procurement 릴레이션
  procurementId   String?      @unique
  procurement     Procurement? @relation(fields: [procurementId], references: [id], onDelete: SetNull)

  collectedAt     DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([assessmentRate])
  @@index([openingDt])
}

// ─────────────────────────────────────────
// 문서24 자동접수 (Phase 27)
// ─────────────────────────────────────────

model Doc24Account {
  id                String   @id @default(cuid())
  userId            String   @unique
  doc24LoginId      String
  encryptedPassword String
  encryptionIv      String
  encryptionTag     String
  displayName       String?
  accountType       String   @default("personal") // personal, corp_rep, corp_member
  isActive          Boolean  @default(true)
  lastUsedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Doc24Submission {
  id              String    @id @default(cuid())
  userId          String
  recipient       String
  recipientCode   String?
  title           String
  content         String?
  attachmentNames String?
  attachmentCount Int       @default(0)
  status          String    @default("pending")
  receiptNumber   String?
  receiptPdfUrl   String?
  screenshotUrl   String?
  errorMessage    String?
  workerJobId     String?
  creditsUsed     Int       @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// 사용자별 관심 키워드 알림 설정
model BidAlertKeyword {
  id          String   @id @default(cuid())
  userId      String
  keyword     String
  type        ProcurementType?  // null이면 전체
  region      String?           // null이면 전체
  minAmount   BigInt?           // 최소 금액 필터
  maxAmount   BigInt?           // 최대 금액 필터
  isActive    Boolean  @default(true)
  lastAlertAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
  @@unique([userId, keyword, type, region])
}

// ─────────────────────────────────────────
// 빌링키 (PortOne V2 구독 결제)
// ─────────────────────────────────────────

model BillingKey {
  id            String         @id @default(cuid())
  userId        String
  billingKey    String         @unique  // PortOne 빌링키
  cardName      String?        // 카드사명 (삼성카드, 현대카드 등)
  cardNumber    String?        // 마스킹된 카드번호 (****-****-****-1234)
  isDefault     Boolean        @default(false)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@index([userId])
}

// ─────────────────────────────────────────
// 자동결제 스케줄
// ─────────────────────────────────────────

model ScheduledPayment {
  id              String       @id @default(cuid())
  subscriptionId  String
  scheduledDate   DateTime
  amount          Int
  status          String       @default("pending") // pending, processing, paid, failed, cancelled
  retryCount      Int          @default(0)
  lastRetryAt     DateTime?
  paidAt          DateTime?
  failReason      String?
  paymentId       String?      // 성공 시 Payment 연결
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([scheduledDate])
  @@index([status])
}

// ─────────────────────────────────────────
// 보조금 프로그램 캐시
// ─────────────────────────────────────────

model SubsidyProgram {
  id              String         @id @default(cuid())
  source          String         @default("manual") // manual, bizinfo, subsidy24
  externalId      String?        // 외부 API ID
  title           String
  agency          String         // 지원기관
  description     String?
  targetIndustry  String?        // 대상업종 (JSON)
  targetScale     String?        // 대상규모 (소기업/중기업/중견기업 등)
  targetRegion    String?        // 대상지역
  targetBizAge    String?        // 대상업력 (예: 3년 이상)
  supportAmount   String?        // 지원금액 설명
  supportType     String?        // 지원유형 (보조금/융자/출연 등)
  applicationStart DateTime?
  applicationEnd   DateTime?
  detailUrl       String?
  requiredDocs    String?        // 필요서류 (JSON)
  eligibility     String?        // 자격요건 상세 (JSON)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  matches         SubsidyMatch[]

  @@unique([source, externalId])
  @@index([source])
  @@index([isActive])
  @@index([applicationEnd])
}

// ─────────────────────────────────────────
// 사용자별 보조금 매칭 결과
// ─────────────────────────────────────────

model SubsidyMatch {
  id                String         @id @default(cuid())
  userId            String
  subsidyProgramId  String
  matchScore        Int            @default(0) // 0~100
  matchedCriteria   String?        // 충족 기준 (JSON)
  unmatchedCriteria String?        // 미충족 기준 (JSON)
  isBookmarked      Boolean        @default(false)
  isApplied         Boolean        @default(false)
  appliedAt         DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  subsidyProgram    SubsidyProgram @relation(fields: [subsidyProgramId], references: [id], onDelete: Cascade)

  @@unique([userId, subsidyProgramId])
  @@index([userId])
  @@index([matchScore])
}

// ─────────────────────────────────────────
// 기한 알림
// ─────────────────────────────────────────

model DeadlineAlert {
  id            String   @id @default(cuid())
  userId        String
  referenceType String   // subscription, subsidy, certification, license, bid
  referenceId   String?
  title         String
  deadline      DateTime
  alertType     String   // d-30, d-7, d-3, d-1, d-day
  isSent        Boolean  @default(false)
  sentAt        DateTime?
  channel       String   @default("in_app") // in_app, email, kakao
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deadline])
  @@index([isSent])
}

// ─────────────────────────────────────────
// 노동행정 AI - 직원 관리 & 급여명세서
// ─────────────────────────────────────────

model Employee {
  id                        String    @id @default(cuid())
  userId                    String
  clientCompanyId           String?   // null이면 내 기업 직원, 값이면 거래처 직원
  name                      String
  birthDate                 DateTime?
  hireDate                  DateTime
  resignDate                DateTime?
  department                String?
  position                  String?
  employmentType            String    @default("regular") // regular, contract, parttime, daily
  monthlySalary             Int       // 월 기본급
  dependents                Int       @default(1)
  childrenUnder20           Int       @default(0)
  nonTaxableAmount          Int       @default(0) // 비과세(식대 등)
  nationalPensionExempt     Boolean   @default(false)
  healthInsuranceExempt     Boolean   @default(false)
  employmentInsuranceExempt Boolean   @default(false)
  weeklyWorkHours           Float     @default(40)
  hourlyWage                Int?
  industryCode              String    @default("30") // 산재보험 업종코드
  isActive                  Boolean   @default(true)
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientCompany             ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  payslips                  Payslip[]
  insuranceReports          InsuranceReport[]

  @@index([userId])
  @@index([clientCompanyId])
}

model Payslip {
  id              String    @id @default(cuid())
  employeeId      String
  userId          String
  year            Int
  month           Int
  baseSalary      Int
  overtimePay     Int       @default(0)
  bonusPay        Int       @default(0)
  otherAllowance  Int       @default(0)
  mealAllowance   Int       @default(0) // 비과세
  totalGross      Int
  deductions      String    // JSON: 각 공제항목 상세
  totalDeduction  Int
  netPay          Int
  employerBurden  String?   // JSON: 사업주 부담분
  status          String    @default("draft") // draft, confirmed
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, year, month])
  @@index([userId])
}

// ─────────────────────────────────────────
// 4대보험 신고서 자동작성
// ─────────────────────────────────────────

model InsuranceReport {
  id           String   @id @default(cuid())
  employeeId   String
  userId       String
  reportType   String   // acquisition, loss, salary_change
  reportData   String   // JSON (전체 양식 데이터)
  status       String   @default("draft") // draft, printed
  createdAt    DateTime @default(now())
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([employeeId])
}

// ─── 법인차량 Fleet 관리 ───

model Vehicle {
  id                String    @id @default(cuid())
  userId            String
  clientCompanyId   String?

  // 차량 기본 정보
  plateNumber       String              // 차량번호 (예: 123가4567)
  vehicleType       String              // sedan, suv, van, truck, bus, special
  manufacturer      String?             // 제조사 (현대, 기아, BMW 등)
  modelName         String?             // 모델명 (소나타, K5 등)
  modelYear         Int?                // 연식
  registrationDate  DateTime?           // 최초등록일
  purchaseDate      DateTime?           // 취득일
  purchasePrice     Int?                // 취득가격 (원)
  displacement      Int?                // 배기량 (cc)
  fuelType          String?             // gasoline, diesel, lpg, electric, hybrid, hydrogen
  color             String?

  // 보험/검사
  insuranceCompany  String?             // 보험사
  insuranceExpiry   DateTime?           // 보험만료일
  inspectionExpiry  DateTime?           // 검사만료일

  // 운행 정보
  currentMileage    Int?                // 현재 주행거리 (km)
  assignedDriver    String?             // 배정 운전자
  purpose           String?             // 업무용, 출퇴근, 영업용

  // 리스/렌트
  ownershipType     String    @default("owned") // owned, lease, rent
  leaseCompany      String?             // 리스/렌트사
  leaseExpiry       DateTime?           // 리스/렌트 만료일
  monthlyPayment    Int?                // 월 리스/렌트료

  // 상태
  status            String    @default("active") // active, maintenance, disposed, transferred
  memo              String?
  isActive          Boolean   @default(true)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  transfers         VehicleTransfer[]
  tripLogs          VehicleTripLog[]
  clientCompany     ClientCompany? @relation(fields: [clientCompanyId], references: [id])

  @@index([userId])
  @@index([clientCompanyId])
  @@index([plateNumber])
}

model VehicleTransfer {
  id              String    @id @default(cuid())
  vehicleId       String
  userId          String

  // 이전등록 정보
  transferType    String              // purchase(매입), sale(매도), name_change(명의변경)
  transferDate    DateTime?
  counterparty    String?             // 상대방 (매도인/매수인)
  transferPrice   Int?                // 거래금액

  // 취등록세 계산 결과
  acquisitionTax  Int?                // 취득세
  registrationTax Int?                // 등록면허세
  educationTax    Int?                // 교육세
  bondAmount      Int?                // 공채매입액
  bondDiscount    Int?                // 공채할인액
  stampTax        Int?                // 인지세
  totalCost       Int?                // 총 비용

  // 서류 상태
  documentsJson   String?             // 생성된 서류 목록 JSON
  status          String    @default("pending") // pending, in_progress, completed, failed

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  vehicle         Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([vehicleId])
}

// ─── 연구노트 (R&D Note) ───
model ResearchNote {
  id              String   @id @default(cuid())
  userId          String
  clientCompanyId String?

  // 과제 정보
  projectName     String           // 연구과제명
  projectCode     String?          // 과제번호
  researchPeriod  String?          // 연구기간

  // 노트 내용
  noteDate        DateTime         // 작성일
  noteNumber      Int      @default(1)  // 노트 번호 (순번)
  title           String           // 제목
  purpose         String?  @db.Text // 연구목적
  content         String   @db.Text // 실험내용/연구내용
  result          String?  @db.Text // 결과
  conclusion      String?  @db.Text // 결론/고찰
  nextPlan        String?  @db.Text // 향후계획
  materials       String?  @db.Text // 사용재료/시약
  equipment       String?  @db.Text // 사용장비

  // 서명
  researcherName  String?          // 연구원명
  supervisorName  String?          // 연구책임자명

  // 메타
  status          String   @default("draft") // draft, signed, archived
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([clientCompanyId])
  @@index([noteDate])
}

// ─── 차량 운행일지 (Vehicle Trip Log) ───
model VehicleTripLog {
  id              String   @id @default(cuid())
  vehicleId       String
  userId          String

  // 운행 정보
  tripDate        DateTime           // 운행일
  driverName      String             // 운전자명
  department      String?            // 부서

  // 거리
  startMileage    Int                // 출발 전 키로수
  endMileage      Int                // 도착 후 키로수
  distance        Int                // 운행거리 (자동계산: endMileage - startMileage)

  // 운행 상세
  departure       String             // 출발지
  destination     String             // 목적지
  purpose         String             // 운행목적 (업무, 출장, 영업, 납품, 기타)
  startTime       String?            // 출발시간 (HH:mm)
  endTime         String?            // 도착시간 (HH:mm)

  // 비용
  fuelCost        Int?               // 주유비 (원)
  tollCost        Int?               // 통행료 (원)
  parkingCost     Int?               // 주차비 (원)
  otherCost       Int?               // 기타비용 (원)
  costMemo        String?            // 비용 메모

  // 메타
  memo            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  vehicle         Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([userId])
  @@index([tripDate])
}
